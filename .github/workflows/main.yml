name: Build_OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup /var/lib/docker/volumes || true
          sudo apt-get remove -y '^dotnet-.*' '^aspnetcore-.*' 'php.*' 'google-cloud-sdk' 'azure-cli' 'microsoft-edge-dev' 'firefox' 'mono-devel' || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          df -h

      - name: Init Environment
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool jq libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
            libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp \
            nano ninja-build p7zip-full patch pkgconf python3 python3-distutils python3-pip \
            python3-venv qemu-utils rsync scons subversion swig texinfo uglifyjs unzip \
            upx-ucl vim wget xmlto xsltproc zlib1g-dev zstd
          df -h

      - name: Clone and Setup
        run: |
          set -e
          git clone --depth 1 https://github.com/coolsnowwolf/lede openwrt
          cd openwrt

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # Passwall（固定使用你指定 repo 版本）
          rm -rf package/passwall || true
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall package/passwall

          # Diskman（避免 feeds 版与手动版双份冲突）
          rm -rf package/feeds/luci/luci-app-diskman package/luci-app-diskman || true
          git clone --depth 1 https://github.com/lisaac/luci-app-diskman package/luci-app-diskman

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 强制移除 autosamba（避免与 samba4-server 冲突）
          rm -rf package/feeds/luci/luci-app-autosamba \
                 package/feeds/packages/autosamba \
                 package/autosamba 2>/dev/null || true

          # opkg 自检：缺失就立即失败，避免浪费时间
          if [ ! -f package/system/opkg/Makefile ]; then
            echo "[FATAL] opkg Makefile missing"
            ls -la package/system || true
            exit 2
          fi

          # 固化网络：LAN=eth1 / WAN=eth0 / 192.168.2.1
          mkdir -p files/etc/uci-defaults
          cat > files/etc/uci-defaults/99-fixed-network <<'EOF'
          #!/bin/sh
          uci -q batch <<EOT
          set network.lan=interface
          set network.lan.proto='static'
          set network.lan.device='eth1'
          set network.lan.ipaddr='192.168.2.1'
          set network.lan.netmask='255.255.255.0'

          set network.wan=interface
          set network.wan.proto='dhcp'
          set network.wan.device='eth0'
          commit network
          EOT
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-fixed-network

          # 固件配置：rootfs=3G + 你必须要的插件/驱动
          cat > .config <<'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y

          CONFIG_LUCI_LANG_zh_Hans=y

          CONFIG_TARGET_KERNEL_PARTSIZE=64
          CONFIG_TARGET_ROOTFS_PARTSIZE=3072
          CONFIG_TARGET_IMAGES_GZ=y

          CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y

          CONFIG_PACKAGE_luci-app-transmission=y
          CONFIG_PACKAGE_transmission-daemon=y
          CONFIG_PACKAGE_transmission-web-control=y

          CONFIG_PACKAGE_luci-app-diskman=y
          CONFIG_PACKAGE_luci-app-samba4=y
          CONFIG_PACKAGE_samba4-server=y

          CONFIG_PACKAGE_block-mount=y
          CONFIG_PACKAGE_kmod-fs-ext4=y
          CONFIG_PACKAGE_kmod-usb-storage=y
          CONFIG_PACKAGE_kmod-usb-storage-uas=y
          CONFIG_PACKAGE_kmod-scsi-core=y
          CONFIG_PACKAGE_kmod-scsi-generic=y

          CONFIG_PACKAGE_fdisk=y
          CONFIG_PACKAGE_lsblk=y
          CONFIG_PACKAGE_parted=y
          CONFIG_PACKAGE_resize2fs=y
          CONFIG_PACKAGE_e2fsprogs=y

          CONFIG_PACKAGE_luci-app-ttyd=y

          # 明确禁用 autosamba（避免 file clash）
          CONFIG_PACKAGE_autosamba=n
          CONFIG_PACKAGE_luci-app-autosamba=n
          EOF

          make defconfig

      - name: Download Sources
        run: |
          set -e
          cd openwrt

          ok=0
          for i in 1 2 3 4 5; do
            echo "[INFO] make download attempt $i/5"
            if make download -j1 V=s; then
              ok=1
              break
            fi
            echo "[WARN] download failed, sleep 15s..."
            sleep 15
          done

          if [ "$ok" -ne 1 ]; then
            echo "[FATAL] make download failed after 5 attempts"
            exit 1
          fi

          # 清掉坏包残片
          find dl -size -1024c -delete
          df -h

      - name: Final Compile
        run: |
          set -e
          cd openwrt

          # tools 容错：避免因为某些 tools 源临时抽风让你整条流水线白跑
          make tools/compile -j2 IGNORE_ERRORS=1 || make tools/compile -j1 V=s IGNORE_ERRORS=1
          make toolchain/compile -j2 || make toolchain/compile -j1 V=s

          (make -j2 || make -j1 V=s) 2>&1 | tee /home/runner/compile.log
          df -h

      - name: List firmware outputs
        if: always()
        run: |
          cd openwrt
          echo "=== firmware files (.img/.img.gz) ==="
          find bin/targets -type f | grep -E '\.(img|img\.gz)$' || true

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build_log
          path: /home/runner/compile.log

      - name: Upload Firmware
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Firmware
          path: openwrt/bin/targets/**/**/*.img*
          if-no-files-found: error
