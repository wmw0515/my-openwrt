name: Build_OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup /var/lib/docker/volumes || true
          sudo apt-get remove -y '^dotnet-.*' '^aspnetcore-.*' 'php.*' 'google-cloud-sdk' 'azure-cli' 'microsoft-edge-dev' 'firefox' 'mono-devel' || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          df -h

      - name: Init Environment
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool jq libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
            libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp \
            nano ninja-build p7zip-full patch pkgconf python3 python3-distutils python3-pip \
            python3-venv qemu-utils rsync scons subversion swig texinfo uglifyjs unzip \
            upx-ucl vim wget xmlto xsltproc zlib1g-dev zstd
          df -h

      - name: Clone and Setup
        run: |
          git clone --depth 1 https://github.com/coolsnowwolf/lede openwrt
          cd openwrt

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          rm -rf package/passwall
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall package/passwall

          rm -rf package/luci-app-diskman
          git clone --depth 1 https://github.com/lisaac/luci-app-diskman package/luci-app-diskman

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          rm -rf package/feeds/luci/luci-app-autosamba \
                 package/feeds/packages/autosamba \
                 package/autosamba || true

          if [ ! -f package/system/opkg/Makefile ]; then
            echo "[FATAL] opkg Makefile missing"
            exit 2
          fi

          mkdir -p files/etc/uci-defaults
          cat > files/etc/uci-defaults/99-fixed-network <<'EOF'
          #!/bin/sh
          uci -q batch <<EOT
          set network.lan=interface
          set network.lan.proto='static'
          set network.lan.device='eth1'
          set network.lan.ipaddr='192.168.2.1'
          set network.lan.netmask='255.255.255.0'
          set network.wan=interface
          set network.wan.proto='dhcp'
          set network.wan.device='eth0'
          commit network
          EOT
          exit 0
          EOF
          chmod +x files/etc/uci-defaults/99-fixed-network

          cat > .config <<'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y

          CONFIG_LUCI_LANG_zh_Hans=y

          CONFIG_TARGET_KERNEL_PARTSIZE=64
          CONFIG_TARGET_ROOTFS_PARTSIZE=3072
          CONFIG_TARGET_IMAGES_GZ=y

          CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y

          CONFIG_PACKAGE_luci-app-transmission=y
          CONFIG_PACKAGE_transmission-daemon=y
          CONFIG_PACKAGE_transmission-web-control=y

          CONFIG_PACKAGE_luci-app-diskman=y
          CONFIG_PACKAGE_luci-app-samba4=y
          CONFIG_PACKAGE_samba4-server=y

          CONFIG_PACKAGE_block-mount=y
          CONFIG_PACKAGE_kmod-fs-ext4=y
          CONFIG_PACKAGE_kmod-usb-storage=y
          CONFIG_PACKAGE_kmod-usb-storage-uas=y
          CONFIG_PACKAGE_kmod-scsi-core=y
          CONFIG_PACKAGE_kmod-scsi-generic=y

          CONFIG_PACKAGE_fdisk=y
          CONFIG_PACKAGE_lsblk=y
          CONFIG_PACKAGE_parted=y
          CONFIG_PACKAGE_resize2fs=y
          CONFIG_PACKAGE_e2fsprogs=y

          CONFIG_PACKAGE_luci-app-ttyd=y
          EOF

          make defconfig

      - name: Download Sources
        run: |
          cd openwrt
          for i in {1..5}; do
            make download -j1 V=s && break || sleep 15
          done
          find dl -size -1024c -delete
          make download V=s || exit 1
          df -h

      - name: Final Compile
        run: |
          set -e
          cd openwrt

          make tools/compile -j2 IGNORE_ERRORS=1 || make tools/compile -j1 V=s IGNORE_ERRORS=1
          make toolchain/compile -j2 || make toolchain/compile -j1 V=s

          (make -j2 || make -j1 V=s) 2>&1 | tee /home/runner/compile.log

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build_log
          path: /home/runner/compile.log

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Firmware
          path: openwrt/bin/targets/x86/64/*.img.gz
